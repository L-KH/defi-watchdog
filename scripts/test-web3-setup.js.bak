// scripts/test-web3-setup.js - Test Web3 Integration
const { ethers } = require('hardhat');

async function testWeb3Setup() {
  console.log('ðŸ§ª Testing DeFi Watchdog Web3 Setup');
  console.log('====================================');

  try {
    // Test 1: Network connection
    console.log('\n1ï¸âƒ£ Testing Network Connection...');
    const network = await ethers.provider.getNetwork();
    console.log(`âœ… Connected to: ${network.name} (${network.chainId})`);

    if (network.chainId !== 11155111) {
      console.log('âš ï¸ Not on Sepolia - run with --network sepolia');
    }

    // Test 2: Account access
    console.log('\n2ï¸âƒ£ Testing Account Access...');
    const [deployer] = await ethers.getSigners();
    const balance = await deployer.getBalance();
    console.log(`âœ… Deployer: ${deployer.address}`);
    console.log(`âœ… Balance: ${ethers.utils.formatEther(balance)} ETH`);

    // Test 3: Contract compilation
    console.log('\n3ï¸âƒ£ Testing Contract Compilation...');
    const DeFiWatchdogAuditNFT = await ethers.getContractFactory('DeFiWatchdogAuditNFT');
    console.log('âœ… Contract compiled successfully');

    // Test 4: Environment variables
    console.log('\n4ï¸âƒ£ Testing Environment Variables...');
    const requiredVars = [
      'SEPOLIA_RPC_URL',
      'PRIVATE_KEY',
      'NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID',
      'PINATA_API_KEY'
    ];

    requiredVars.forEach(varName => {
      const value = process.env[varName];
      if (value) {
        console.log(`âœ… ${varName}: ${'*'.repeat(10)}${value.slice(-4)}`);
      } else {
        console.log(`âŒ ${varName}: Missing`);
      }
    });

    // Test 5: Check if contract is deployed
    console.log('\n5ï¸âƒ£ Testing Deployed Contract...');
    const contractAddress = process.env.NEXT_PUBLIC_AUDIT_NFT_CONTRACT;
    
    if (contractAddress && contractAddress !== '0x449a12495A524fC7EA7A37a26b13d55911e51344') {
      try {
        const code = await ethers.provider.getCode(contractAddress);
        if (code !== '0x') {
          console.log(`âœ… Contract deployed at: ${contractAddress}`);
          
          // Try to call contract
          const contract = new ethers.Contract(contractAddress, [
            'function name() view returns (string)',
            'function symbol() view returns (string)'
          ], ethers.provider);
          
          const name = await contract.name();
          const symbol = await contract.symbol();
          console.log(`âœ… Contract name: ${name}`);
          console.log(`âœ… Contract symbol: ${symbol}`);
        } else {
          console.log(`âŒ No contract at: ${contractAddress}`);
        }
      } catch (error) {
        console.log(`âŒ Contract test failed: ${error.message}`);
      }
    } else {
      console.log('âŒ Contract not deployed or using old address');
      console.log('ðŸ’¡ Run: npm run fix-web3');
    }

    console.log('\nðŸŽ¯ Test Summary');
    console.log('===============');
    if (network.chainId === 11155111 && balance.gt(ethers.utils.parseEther('0.005'))) {
      console.log('âœ… Ready to deploy contract');
    } else {
      console.log('âš ï¸ Need Sepolia ETH or wrong network');
    }

    if (process.env.NEXT_PUBLIC_AUDIT_NFT_CONTRACT && process.env.NEXT_PUBLIC_AUDIT_NFT_CONTRACT !== '0x449a12495A524fC7EA7A37a26b13d55911e51344') {
      console.log('âœ… Contract appears to be deployed');
    } else {
      console.log('âŒ Need to deploy contract');
    }

    console.log('\nðŸš€ Next Steps:');
    if (network.chainId !== 11155111) {
      console.log('1. Run with: npx hardhat run scripts/test-web3-setup.js --network sepolia');
    } else if (balance.lt(ethers.utils.parseEther('0.005'))) {
      console.log('1. Get Sepolia ETH: https://sepoliafaucet.com/');
      console.log('2. Run: npm run fix-web3');
    } else if (!process.env.NEXT_PUBLIC_AUDIT_NFT_CONTRACT || process.env.NEXT_PUBLIC_AUDIT_NFT_CONTRACT === '0x449a12495A524fC7EA7A37a26b13d55911e51344') {
      console.log('1. Deploy contract: npm run fix-web3');
    } else {
      console.log('âœ… Everything looks good! Start dev server: npm run dev');
    }

  } catch (error) {
    console.error('âŒ Test failed:', error.message);
    throw error;
  }
}

// Run test
if (require.main === module) {
  testWeb3Setup()
    .then(() => {
      console.log('\nâœ… Web3 setup test complete');
      process.exit(0);
    })
    .catch((error) => {
      console.error(`\nðŸ’¥ Test failed: ${error.message}`);
      process.exit(1);
    });
}

module.exports = { testWeb3Setup };